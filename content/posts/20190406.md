---
title: "プロダクションレディマイクロサービスを読んだ"
date: 2019-04-06T17:40:58+09:00
draft: false
summary: "プロダクションレディマイクロサービスを読んだ
          今まで、マイクロサービスと口にはしていたものの、その概念を理解しきれていないと思ったので、この本を読みました。
          kubernetesを学ぶ上でもマイクロサービスとは何かを理解していないと、活かしきれないのではないかとも思っていました。
          本編はおよそ160ページとページ数も少なく、すぐ読めるのでおすすめです"
---

# プロダクションレディマイクロサービスを読んだ
今まで、マイクロサービスと口にはしていたものの、その概念を理解しきれていないと思ったので、この本を読みました。
Kubernetesを学ぶ上でもマイクロサービスとは何かを理解していないと、活かしきれないのではないかとも思っていました。
本編はおよそ160ページとページ数も少なく、すぐ読めるのでおすすめです。

## 概要
この本のタイトルの一部でもある、プロダクションレディとは直訳すると「本番対応」という意味だそうです。
この本は本番対応のマイクロサービスとはどのようなものであるべきかといったことについて述べられています。

## なぜマイクロサービスなのか
本の冒頭ではマイクロサービスとは何か、なぜ、マイクロサービスで作るのかということが書かれています。
個人的にはこの序盤の部分がかなり勉強になりました。

### 大規模でモノリスなアプリケーションの問題
大規模でモノリスなアプリケーションの問題は大きく分けると以下の2つです。

- デプロイスピードが遅くなる
- タスクの処理スピードの向上が難しい

#### デプロイスピードが遅くなる
モノリスなシステムは、コード量が肥大していけばしていくほど、複雑になっていきます。
複雑なシステムに変更やバグの修正をしたときに、その変更箇所がどこの影響するのかということが極めて難しくなります。
自分ではこの箇所にしか影響がないと、思いその部分だけテストして、デプロイをしてみると、
想定していないところにまで、影響があり、バグを引き起こしてしまうということもあります。

逆に、影響箇所を徹底的に潰しすために、テストを重厚に行おうとすると、システムが複雑すぎて、
テストケースが無限に増え、リリースまでの時間がかかりすぎてしまいます。

#### タスクの処理スピードの向上が難しい
ある程度アプリケーションが大きくなってくると、１つのリクエストに対してのタスク数は多くなっていきます。
そのタスクを同期的に行なっていると、レスポンスまでにかかる時間も当然長くなります。
場合によってはサーバー側のタスクの遅延が大きすぎて、アプリケーションが実用的ではなくなってしまうこともあります。
モノリスなサービスはタスクの処理時間がかかりすぎてしまうという問題に対して、サーバーのスケールアップという対策しか
できないのです。(スケールアップとはサーバーのハードウェアのスペックをあげることです。)

### マイクロサービスとは
モノリスのアプリケーションを独立したタスクで分割して、
それらが協調して、動作するサービスのことがマイクロサービスです。

レイヤードアーキテクチャは、ソースコードをクラスの役割によって分割し、モジュール間の独立性を高めるように、
マイクロサービスはタスクごとにサービスとして分割し、サービス間の独立性を高めたものです。
マイクロサービスの１サービスは他のサービスのことを知る必要はなく、自分に与えられたタスクを淡々とこなすだけです。

マイクロサービスに分割することでモノリスなアプリケーションの課題であった、

- デプロイスピード
- 並行性

という問題に対して、対応できるようになります。

#### デプロイスピード
マイクロサービスの１サービスは独立しているため、マイクロサービスの他のサービスについて考える必要はありません。
マイクロサービスの１サービスで変更があった場合、サービスの中で、動作の確保だけをすればいいため、
重厚なテストケースをこなす必要はありません。（テストしなくてはいいということではなく、必要なテストはもちろん行います。）
自分のことだけを考えて、デプロイが可能であるため、デプロイスピードは向上します。
また、各サービスのデプロイスピードが向上することによって、サービス全体はよりユーザーにとって価値のあるものになります。

#### 並行性
マイクロサービスはタスクごとに分割されているため、並行に処理することも可能になります。
あるサービスAにリクエストを行い、サービスBにリクエストを行う、ということを並行に行えば、サービス全体のタスクの処理時間は短くすることができます。
実際、多くの企業のマイクロサービスで並行にタスクを処理する方法として、Pub/Sub戦略がよく活用されています。
もし、１サービスのタスクが発行され過ぎて、処理が滞ってしまうのであれば、サービスをスケールアウトすれば良いのです。（スケールアウトとは同様のサービスを提供するサーバーの数を増やすことです。）
もちろん、スケールアップもモノリスなアプリケーション同様に可能です。

#### マイクロサービスにすることの難しさ
マイクロサービスにはメリットもありますが、
各サービスがスケールアウトして、分散アプリケーションになることにアーキテクチャが複雑になります。

マイクロサービスは４つのレイヤーから構成されると、本書では述べられていました。

- インフラストラクチャーレイヤー
- 通信レイヤー
- アプリケーションプラットフォームレイヤー
- マイクロサービスレイヤー

#### インフラストラクチャーレイヤー
インフラストラクチャーレイヤーとは主にハードウェアを管理するレイヤーです。
アプリケーションをスケールアウトするには当然、サーバーの管理が必要です。
現在はインフラをクラウドを用いて、インフラストラクチャーを構成することが多いです。
インフラレイヤーの役割は以下の４つです。

- サーバーの管理
- DBの管理
- OSの管理
- インフラレベルでの監視、ロギング
- （リソースの抽象化、割り当て）

#### 通信レイヤー
通信レイヤーはサービス間の通信を問題なく、行えるように管理するレイヤーです。
１サービスはスケールアウトによって、分散されているため、ロードバランシングやサービスディスカバリが必要不可欠です。
DNSによる名前解決もこのレイヤーで管理されます。
通信に必要なTLSの証明書の管理もこのレイヤーで行われます。

#### アプリケーションプラットフォームレイヤー
このレイヤーはアプリケーションのCI、CDの管理、アプリケーションのロギング、メトリクスの監視を行うレイヤーです。
うまく、アプリケーションが動作することを補助するような役割です。

#### マイクロサービスレイヤー
言わずもがな、アプリケーションに関するレイヤーです。

マイクロサービスでは４つレイヤーが適切に動作することを確保することが必要不可欠です。
動作の確保するためには、各レイヤーごとにチームを割り当て、チームごとに役割をこなします。
チームを割り当てずに１つのチームだけで全てを行うことはやはり難しいです。
なぜなら、この４つのレイヤーを全てまっとうするには膨大な知識量と、作業を行う時間が必要だからです。
たとえ、４つのレイヤーを全て理解しているようなスーパーエンジニアが企業にいたとしても、
これらをチューニングするにはスーパーエンジニアが数人いるだけでは時間が足りません。

逆に言えば、これのレイヤーに人員を割り当てることができないのであれば、
本番対応可能なマイクロサービスを作り、動作させることは不可能であると本書では言われていました。

ソースコードやサービスだけでなく、チームも独立させる必要があるようです。
チームを独立させることで、サイロ化されるというデメリットも当然あります。
本当に難しいですね。
逆コンウェイの法則でも述べられているように、組織が分割され、独立していなければ、サービスも分割され、独立しないということです。

## プロダクションレディ（本番対応可能）
モノリスなアプリケーションをマイクロサービスに分割できたとしても、そのマイクロサービスがうまく動作していなければ（プロダクションレディでなければ）、意味がありません。
マイクロサービスがプロダクションレディかをはかる指標として、可用性についてのSLA（サービスレベルアグリーメント）があります。
サービスがどれくらい時間止まることなく動いていたかということです。
可用性についてSLAとして、よく以下の目標が掲げられます。

- 99%の可用性
    - 年に3.65日のダウンタイムを許容
    - 月に7.20時間のダウンタイムを許容
- 99.9%の可用性
    - 年に8.76時間のダウンタイムを許容
    - 月に43.8分のダウンタイムを許容
- 99.99%の可用性
    - 年に52.56分のダウンタイムを許容
    - 月に4.38分のダウンタイムを許容

高水準な可用性についてのSLAを満たすためには以下のことが確保されていることが必要と本書では述べられていました。

- 安定性 
- 信頼性
- スケーラビリティ
- 耐障害性
- 大惨事対応
- パフォーマンス
- 監視
- ドキュメント

これらについて本書では述べられていました。
これら全てについてまとめるのはしんどいので、ここら辺で終わります笑。
この本を読んでみて、マイクロサービスとは何かといのがよくわかりました。自分は今までマイクロサービスについて全然理解していなかったなと。
また、プロダクションレディを達成する方法として、Kubernetesを活用することが有効だと感じました。
やはり、Kubernetesはマイクロサービスを推進するようなツールだということです。
次は改めてKubernetesについて勉強していこうと思います。以上。